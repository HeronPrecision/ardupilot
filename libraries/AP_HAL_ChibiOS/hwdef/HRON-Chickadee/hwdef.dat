# hw definition file for processing by chibios_hwdef.py
# for HRON-Chickadee hardware.

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# board ID for firmware load
APJ_BOARD_ID AP_HW_HRON_Chickadee

USB_STRING_MANUFACTURER "HRON"

# crystal frequency, setup to use external oscillator
OSCILLATOR_HZ 25000000

# MCU_CLOCKRATE_MHZ 480

FLASH_SIZE_KB 2048

# bootloader takes first sector
FLASH_RESERVE_START_KB 128

STORAGE_FLASH_PAGE 14
define HAL_STORAGE_SIZE 32768

# ChibiOS system timer
# STM32_ST_USE_TIMER 12
STM32_ST_USE_TIMER 5
define CH_CFG_ST_RESOLUTION 16

# SPI devices

# SPI1 (IMU1 and IMU2)
PB3 SPI1_SCK SPI1
PB4 SPI1_MISO SPI1
PB5 SPI1_MOSI SPI1

# SPI4 (IMU3 and Baro)
PE2 SPI4_SCK SPI4
PE5 SPI4_MISO SPI4
PE6 SPI4_MOSI SPI4

# SPI6 (OSD)
PA5 SPI6_SCK SPI6
PA6 SPI6_MISO SPI6
PA7 SPI6_MOSI SPI6

# Chip select pins
PB2 GYRO1_CS CS
PB15 GYRO2_CS CS
PE4 GYRO3_CS CS
PE3 BARO_CS CS
PA4 MAX7456_CS CS

# Beeper - PE1 can also be TX for UART8
PE1 BUZZER OUTPUT GPIO(80) LOW PULLDOWN
define HAL_BUZZER_PIN 80

# SERIAL ports
SERIAL_ORDER OTG1 USART1 USART2 USART3 UART4 USART6 UART7 UART8
# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# USART1
PA10 USART1_RX USART1
PB14 USART1_TX USART1
define DEFAULT_SERIAL1_PROTOCOL SerialProtocol_MSP_DisplayPort

# USART2
PA2 USART2_TX USART2
PA3 USART2_RX USART2

# USART3
PD8 USART3_TX USART3
PD9 USART3_RX USART3
define DEFAULT_SERIAL3_PROTOCOL SerialProtocol_GPS

# UART4
PB8 UART4_RX UART4
PB9 UART4_TX UART4

# USART6
PC6 USART6_TX USART6
PC7 USART6_RX USART6

# UART7
PE8 UART7_TX UART7
PA8 UART7_RX UART7

# UART8
PE0 UART8_RX UART8
# PE1 UART8_TX UART8
define DEFAULT_SERIAL8_PROTOCOL SerialProtocol_ESCTelemetry
 
# I2C ports
I2C_ORDER I2C1
# I2C1 for BMM350 compass
PB6 I2C1_SCL I2C1
PB7 I2C1_SDA I2C1

# Compass - BMM350 on I2C1
# COMPASS BMM350 I2C:0:0x14
# define AP_COMPASS_BMM350_ENABLED 1

# Barometer - ICP201XX on SPI4
# SPIDEV baro SPI4 DEVID1 BARO_CS MODE3 1*MHZ 8*MHZ
# BARO ICP201XX SPI:baro
# define AP_BARO_ICP201XX_ENABLED 1

# ADC ports
# ADC1
PC0 BATT_VOLTAGE_SENS ADC1 SCALE(1)
define HAL_BATT_VOLT_PIN 10
define HAL_BATT_VOLT_SCALE 14.3
PC3 BATT_CURRENT_SENS ADC1 SCALE(1)
define HAL_BATT_CURR_PIN 13
define HAL_BATT_CURR_SCALE 16.8
PC4 BATT2_CURRENT_SENS ADC1 SCALE(1)
define HAL_BATT_MONITOR_DEFAULT 4

# MOTORS - up to 12 motors supported
PE9  TIM1_CH1  TIM1  PWM(1)  GPIO(50)       # M1
PE11 TIM1_CH2  TIM1  PWM(2)  GPIO(51)       # M2
PE13 TIM1_CH3  TIM1  PWM(3)  GPIO(52)       # M3
PE14 TIM1_CH4  TIM1  PWM(4)  GPIO(53)       # M4
PD12 TIM4_CH1  TIM4  PWM(5)  GPIO(54)       # M5
PD13 TIM4_CH2  TIM4  PWM(6)  GPIO(55)       # M6
PD14 TIM4_CH3  TIM4  PWM(7)  GPIO(56)       # M7
PD15 TIM4_CH4  TIM4  PWM(8)  GPIO(57)       # M8
PA0  TIM2_CH1  TIM2  PWM(9)  GPIO(58)       # M9/S1
PA1  TIM2_CH2  TIM2  PWM(10) GPIO(59)       # M10/S2
PB10 TIM2_CH3  TIM2  PWM(11) GPIO(60)       # M11/S3
PB11 TIM2_CH4  TIM2  PWM(12) GPIO(61)       # M12/S4

# PINIO pins for various functions
PE10 PINIO1 OUTPUT GPIO(81) HIGH  # Camera selector (1 = HIGH, 2 = LOW)
PE12 PINIO2 OUTPUT GPIO(82) HIGH # TX6 enable (HIGH for gnd)
PC13 PINIO3 OUTPUT GPIO(83) LOW  # M9-10 enable (pull down to enable)
PE7  PINIO4 OUTPUT GPIO(84) LOW  # M11-12 enable (pull down to enable) 
PD10 PINIO5 OUTPUT GPIO(85) HIGH # Route picker (high for motors)
PD11 PINIO6 OUTPUT GPIO(86) HIGH # Route picker (high for motors)

# LEDs
PA13 LED0 OUTPUT LOW GPIO(90)  # Blue LED
define HAL_GPIO_A_LED_PIN 90

PA15 LED1 OUTPUT LOW GPIO(91)  # Green LED  
define HAL_GPIO_B_LED_PIN 91

PA14 LED2 OUTPUT LOW GPIO(92)  # Red LED
define HAL_GPIO_C_LED_PIN 92

define HAL_GPIO_LED_ON 1
define AP_NOTIFY_GPIO_LED_2_ENABLED 1
define AP_NOTIFY_GPIO_LED_3_ENABLED 1

# SD Card - follow proper ArduPilot structure
include sdcard.inc

define HAL_OS_FATFS_IO 1

# OSD setup
SPIDEV osd SPI6 DEVID1 MAX7456_CS MODE0 10*MHZ 10*MHZ

define OSD_ENABLED 1
define HAL_OSD_TYPE_DEFAULT 1
ROMFS_WILDCARD libraries/AP_OSD/fonts/font*.bin

# IMU setup - 3 ICM42688P gyros
SPIDEV imu1 SPI1 DEVID1 GYRO1_CS MODE3 1*MHZ 16*MHZ
SPIDEV imu2 SPI1 DEVID2 GYRO2_CS MODE3 1*MHZ 16*MHZ  
SPIDEV imu3 SPI4 DEVID2 GYRO3_CS MODE3 1*MHZ 16*MHZ

IMU Invensensev3 SPI:imu1 ROTATION_YAW_180
IMU Invensensev3 SPI:imu2 ROTATION_YAW_90
IMU Invensensev3 SPI:imu3 ROTATION_YAW_90

# Clock output pin for gyro synchronization (MCU generates sync clock)
PB0 GYRO_CLKOUT OUTPUT

# Interrupt pins for gyros
PB1 GYRO1_EXTI INPUT
PD5 GYRO2_EXTI INPUT
PE15 GYRO3_EXTI INPUT

# DMA_NOSHARE TIM1_UP TIM2_UP TIM4_UP SPI1* SPI4* SPI6*
# DMA_PRIORITY TIM1_UP TIM2_UP TIM4_UP SPI1* SPI4* SPI6*
DMA_NOSHARE = SPI1* SPI4*
DMA_PRIORITY = S*

# USB detection pin
PA9 USB_DETECT INPUT

# bmm350 integrated, but also probe external I2C buses
define AP_COMPASS_PROBING_ENABLED 1
define HAL_I2C_INTERNAL_MASK 0
define HAL_COMPASS_AUTO_ROT_DEFAULT 2
define HAL_DEFAULT_INS_FAST_SAMPLE 3

# Motor order implies Betaflight/X for standard ESCs
# define HAL_FRAME_TYPE_DEFAULT 12
# define DEFAULT_NTF_LED_TYPES 455
define DEFAULT_NTF_LED_TYPES 257

# Enable multiple gyros
define HAL_INS_NUM_GYROS 3
define HAL_INS_NUM_ACCELS 3
